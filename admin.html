<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Anime Quiz Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      background: linear-gradient(120deg,#260154,#4d0154 80%);
      color: #fff;
      font-family: 'Poppins', sans-serif;
      padding: 18px 14px;
      max-width: 680px;
      margin: auto;
      border-radius: 16px;
      box-shadow: 0 0 25px #ff4dc4;
    }
    h1 {
      font-family: 'Ninja Naruto', cursive;
      color: #ff4dc4;
      text-align: center;
      margin-bottom: 20px;
    }
    section {
      margin-bottom: 30px;
      background: rgba(30,0,60,0.21);
      padding: 18px 15px;
      border-radius: 10px;
      box-shadow: inset 0 0 15px #a03aff8b;
    }
    label {
      font-weight: 600;
      color: #ffd1fb;
      margin-top: 12px;
      display: inline-block;
    }
    input[type="text"], input[type="number"], textarea, select {
      background: rgba(255,255,255,0.15);
      border:none;
      border-radius: 6px;
      padding: 10px 12px;
      font-family: monospace, 'Poppins', sans-serif;
      font-size: 14px;
      color: #fff;
      margin-top: 4px;
      width: 100%;
      box-sizing: border-box;
      resize: vertical;
    }
    textarea {
      min-height: 130px;
    }
    button {
      margin-top: 12px;
      background: linear-gradient(90deg, #ff4dc4 45%, #a449ff 90%);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-weight: 900;
      font-size: 16px;
      padding: 12px;
      width: 100%;
      cursor: pointer;
      box-shadow: 0 0 18px #ff4dc4;
      user-select: none;
      transition: background 0.3s ease;
    }
    button:disabled {
      filter: grayscale(0.6);
      cursor: default;
    }
    button:hover:not(:disabled) {
      background: linear-gradient(90deg, #a449ff 50%, #ff4dc4 90%);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }
    th, td {
      padding: 9px 8px;
      border: 1px solid #572a7e;
      text-align: center;
      color: #ffb1ff;
      vertical-align: middle;
    }
    th {
      background: #540666;
      font-weight: 700;
    }
    .btn-small {
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 700;
      border-radius: 8px;
      user-select: none;
    }
    .btn-block {
      background: #ba002c;
      color: #fff;
      border:none;
      cursor:pointer;
    }
    .btn-unblock {
      background: #00b24e;
      color: #fff;
      border:none;
      cursor:pointer;
    }
    .btn-edit {
      background: #ffd100;
      color: #3a157e;
      border:none;
      cursor:pointer;
      margin-right: 6px;
    }
    .btn-delete {
      background: #ff3f3f;
      color: #fff;
      border:none;
      cursor:pointer;
    }
    #statusMsg {
      margin-top: 15px;
      font-weight: 700;
      color: #ffb1ff;
      text-align: center;
      min-height: 22px;
      user-select: none;
      font-size: 15px;
    }
  </style>
</head>
<body>
  <h1>Anime Quiz Admin Panel</h1>
  <div id="statusMsg"></div>

  <section id="usersSection">
    <h2>Users Management</h2>
    <table id="usersTable">
      <thead>
        <tr>
          <th>UID</th>
          <th>Name / Email</th>
          <th>Level</th>
          <th>XP</th>
          <th>Blocked</th>
          <th>Actions (Block / XP)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="quizzesSection">
    <h2>Quizzes Management</h2>
    <table id="quizzesTable">
      <thead>
        <tr>
          <th>Category</th>
          <th>Quiz ID</th>
          <th>Actions (Edit / Delete)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section>
    <h2>Bulk Upload Quiz Questions</h2>
    <label for="categoryInput">Category Name</label>
    <input id="categoryInput" type="text" placeholder="e.g. naruto" />
    <label for="quizInput">Quiz Name</label>
    <input id="quizInput" type="text" placeholder="e.g. quiz1" />
    <label for="jsonInput">Questions JSON Array</label>
    <textarea id="jsonInput" placeholder='[{"q":"Question?","options":["A","B","C","D"],"answer":"A"}, ...]'></textarea>
    <button id="uploadBtn">Upload Questions</button>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getFirestore, collection, doc, getDocs, onSnapshot, updateDoc,
      deleteDoc, addDoc, writeBatch, getDoc
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCw5PitKPzzRBWdlZiI-Csm-N3av_9lIqQ",
      authDomain: "anime001-d6669.firebaseapp.com",
      projectId: "anime001-d6669",
      storageBucket: "anime001-d6669.appspot.com",
      messagingSenderId: "1005431495919",
      appId: "1:1005431495919:web:dfbf43ba8a2a8ae5db4f1a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const adminUID = "7lANMvk2qZUd5tirkIYhJSepKv63";

    const statusMsg = document.getElementById("statusMsg");
    const usersTableBody = document.querySelector("#usersTable tbody");
    const quizzesTableBody = document.querySelector("#quizzesTable tbody");
    const categoryInput = document.getElementById("categoryInput");
    const quizInput = document.getElementById("quizInput");
    const jsonInput = document.getElementById("jsonInput");
    const uploadBtn = document.getElementById("uploadBtn");

    function showStatus(msg, error = false) {
      statusMsg.textContent = msg;
      statusMsg.style.color = error ? "tomato" : "limegreen";
      setTimeout(() => (statusMsg.textContent = ""), 4000);
    }

    onAuthStateChanged(auth, (user) => {
      if (!user || user.uid !== adminUID) {
        alert("Access denied! Admin only.");
        window.location.href = "index.html";
        return;
      }
      // Load users and quizzes live
      loadUsers();
      loadQuizzes();
    });

    // Load users live with block/unblock and XP controls
    function loadUsers() {
      const usersRef = collection(db, "users");
      onSnapshot(usersRef, (snapshot) => {
        usersTableBody.innerHTML = "";
        snapshot.forEach((doc) => {
          const data = doc.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${doc.id}</td>
            <td>${data.displayName || ""} <br><small>${data.email || ""}</small></td>
            <td>${data.level || 1}</td>
            <td>${data.xp || 0}</td>
            <td>${data.blocked ? "Yes" : "No"}</td>
            <td>
              <button class="btn-small btn-block">${data.blocked ? "Unblock" : "Block"}</button>
              <input type="number" class="xpInput" placeholder="XP +" style="width:60px; margin-left:8px" />
              <button class="btn-small btn-edit">Add XP</button>
              <button class="btn-small btn-edit" style="margin-left:6px;">Sub XP</button>
            </td>
          `;
          // Buttons Functionality
          const blockBtn = tr.querySelector(".btn-block");
          const addXPBtn = tr.querySelectorAll(".btn-edit")[0];
          const subXPBtn = tr.querySelectorAll(".btn-edit")[1];
          const xpInput = tr.querySelector(".xpInput");

          blockBtn.onclick = async () => {
            try {
              await updateDoc(doc(db, "users", doc.id), {
                blocked: !data.blocked,
              });
              showStatus(`User ${!data.blocked ? "blocked" : "unblocked"}!`);
            } catch {
              showStatus("Failed to update block", true);
            }
          };
          addXPBtn.onclick = async () => {
            const xpToAdd = parseInt(xpInput.value);
            if (isNaN(xpToAdd) || xpToAdd <= 0) return alert("Enter valid XP");
            try {
              const userRef = doc(db, "users", doc.id);
              const userSnap = await getDoc(userRef);
              const currentXP = userSnap.data()?.xp || 0;
              await updateDoc(userRef, { xp: currentXP + xpToAdd });
              showStatus(`Added ${xpToAdd} XP to ${data.displayName || doc.id}`);
              xpInput.value = "";
            } catch {
              showStatus("Failed to add XP", true);
            }
          };
          subXPBtn.onclick = async () => {
            const xpToSub = parseInt(xpInput.value);
            if (isNaN(xpToSub) || xpToSub <= 0) return alert("Enter valid XP");
            try {
              const userRef = doc(db, "users", doc.id);
              const userSnap = await getDoc(userRef);
              const currentXP = userSnap.data()?.xp || 0;
              await updateDoc(userRef, { xp: Math.max(0, currentXP - xpToSub) });
              showStatus(`Subtracted ${xpToSub} XP from ${data.displayName || doc.id}`);
              xpInput.value = "";
            } catch {
              showStatus("Failed to subtract XP", true);
            }
          };
          usersTableBody.appendChild(tr);
        });
      });
    }

    // Load quizzes with edit and delete options
    function loadQuizzes() {
      const quizzesRef = collection(db, "quizzes");
      onSnapshot(quizzesRef, async (snapshot) => {
        quizzesTableBody.innerHTML = "";
        for (const doc of snapshot.docs) {
          const category = doc.id;
          const subQuizzesRef = collection(db, "quizzes", category, "subQuizzes");
          const subSnap = await getDocs(subQuizzesRef);
          subSnap.forEach((qdoc) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${category}</td>
              <td>${qdoc.id}</td>
              <td>
                <button class="btn-small btn-edit">Edit</button>
                <button class="btn-small btn-delete">Delete</button>
              </td>
            `;
            // Edit button opens prompt to change quiz name
            const editBtn = tr.querySelector(".btn-edit");
            const deleteBtn = tr.querySelector(".btn-delete");

            editBtn.onclick = async () => {
              const newName = prompt("Enter new quiz name", qdoc.id);
              if (newName && newName !== qdoc.id) {
                // Create new quiz doc, move questions and delete old quiz (complex)
                alert(
                  "Rename quiz functionality coming soon; currently not supported."
                );
              }
            };
            deleteBtn.onclick = async () => {
              if (!confirm(`Delete quiz '${qdoc.id}' in category '${category}'? This cannot be undone.`))
                return;
              try {
                // Delete all questions then quiz
                const questionsRef = collection(
                  db,
                  "quizzes",
                  category,
                  "subQuizzes",
                  qdoc.id,
                  "questions"
                );
                const questionsSnap = await getDocs(questionsRef);
                const batch = writeBatch(db);
                questionsSnap.forEach((qdoc) => batch.delete(qdoc.ref));
                await batch.commit();
                await deleteDoc(
                  doc(db, "quizzes", category, "subQuizzes", qdoc.id)
                );
                showStatus(`Deleted quiz '${qdoc.id}'`);
              } catch {
                showStatus("Quiz deletion failed", true);
              }
            };
            quizzesTableBody.appendChild(tr);
          });
        }
      });
    }

    // Bulk question upload
    uploadBtn.onclick = async () => {
      const category = categoryInput.value.trim();
      const quiz = quizInput.value.trim();
      const json = jsonInput.value.trim();
      if (!category) return showStatus("Please enter category", true);
      if (!quiz) return showStatus("Please enter quiz name", true);
      if (!json) return showStatus("Please paste JSON", true);
      let questions;
      try {
        questions = JSON.parse(json);
      } catch {
        return showStatus("Invalid JSON format", true);
      }
      if (!Array.isArray(questions))
        return showStatus("JSON must be an array of questions", true);
      uploadBtn.disabled = true;
      let added = 0;
      showStatus("Uploading questions...");
      for (let q of questions) {
        if (
          q.q &&
          Array.isArray(q.options) &&
          q.options.length === 4 &&
          q.answer &&
          q.options.includes(q.answer)
        ) {
          try {
            await addDoc(
              collection(db, "quizzes", category, "subQuizzes", quiz, "questions"),
              q
            );
            added++;
          } catch {}
        }
      }
      uploadBtn.disabled = false;
      if (added > 0) {
        showStatus(`Added ${added} questions to ${category}/${quiz}`);
        jsonInput.value = "";
      } else {
        showStatus("No valid questions found", true);
      }
    };
  </script>
</body>
</html>
